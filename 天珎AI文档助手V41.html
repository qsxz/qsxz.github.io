<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©çAIæ–‡æ¡£åŠ©æ‰‹ V41 (çµçŒ«Â·æ— ç‘•ç‰ˆ)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/diff@5.1.0/dist/diff.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 2px; }
        
        textarea:focus { outline: none; }
        body {
            font-family: "Noto Sans SC", system-ui, -apple-system, sans-serif;
            background-color: #f8fafc;
            overflow: hidden; 
        }
        
        /* æ‹–æ‹½æ¡ä¸æ»‘å— */
        .resizer { width: 4px; cursor: col-resize; background-color: #f1f5f9; transition: background-color 0.2s; z-index: 40; flex: none; }
        .resizer:hover, .resizer.active { background-color: #3b82f6; }
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3b82f6; margin-top: -6px; 
            box-shadow: 0 0 0 2px white, 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: transparent; }

        /* --- é«˜äº®æ ·å¼ --- */
        .highlight-mode mark { background-color: #fef08a; color: #854d0e; padding: 0 1px; border-radius: 2px; border-bottom: 3px solid #eab308; cursor: help; font-weight: 800; }
        .highlight-mode del { background-color: #fee2e2; color: #b91c1c; text-decoration: line-through; padding: 0 1px; font-weight: 800; }
        .highlight-mode ins { background-color: #dcfce7; color: #15803d; text-decoration: none; border-bottom: 3px solid #22c55e; padding: 0 1px; font-weight: 800; }

        /* æ ‡ç‚¹ç‰¹å®šé«˜äº® */
        .highlight-broken mark { background-color: #fca5a5 !important; border-bottom-color: #dc2626 !important; } /* çº¢è‰²ç³» */
        .highlight-symmetric mark { background-color: #93c5fd !important; border-bottom-color: #2563eb !important; } /* è“è‰²ç³» */
        .highlight-other mark { background-color: #e2e8f0 !important; border-bottom-color: #94a3b8 !important; } /* ç°è‰²ç³» */

        /* ç­›é€‰æ¨¡å¼ */
        .show-only-broken .highlight-symmetric, .show-only-broken .highlight-other { background-color: transparent !important; border-bottom: none !important; color: inherit !important; font-weight: normal !important; }
        .show-only-symmetric .highlight-broken, .show-only-symmetric .highlight-other { background-color: transparent !important; border-bottom: none !important; color: inherit !important; font-weight: normal !important; }

        /* å­—å½¢æ£€æŸ¥é«˜äº® */
        .highlight-sc { background-color: #fef08a; color: #b91c1c; border-bottom: 3px solid #ef4444; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 900; }
        .highlight-tc { background-color: #bfdbfe; color: #1e3a8a; border-bottom: 3px solid #2563eb; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 900; }
        .highlight-variant { background-color: #bbf7d0; color: #14532d; border-bottom: 3px solid #16a34a; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 900; }
        .highlight-old { background-color: #e9d5ff; color: #581c87; border-bottom: 3px solid #9333ea; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 900; }
        .highlight-confusion-error { background-color: #ffccbc; color: #b71c1c; border-bottom: 3px solid #d32f2f; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 900; }
        .highlight-confusion-suspect { background-color: #fff3e0; color: #e65100; border-bottom: 3px dotted #ff9800; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 800; }
        .highlight-sc-error { background-color: #fecaca; color: #7f1d1d; border-bottom: 3px solid #dc2626; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 900; }
        .highlight-word-fail { background-color: #fbcfe8; color: #831843; border-bottom: 3px solid #db2777; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 900; }
        .highlight-taiwan { background-color: #a5f3fc; color: #164e63; border-bottom: 3px solid #0891b2; cursor: pointer; padding: 0 1px; border-radius: 2px; font-weight: 900; }
        .highlight-uncertain { background-color: #fce7f3; color: #db2777; border-bottom: 3px dotted #be185d; cursor: help; padding: 0 1px; border-radius: 2px; font-weight: 900; }

        .hide-suspects .highlight-confusion-suspect { background-color: transparent !important; color: inherit !important; border-bottom: none !important; cursor: text !important; font-weight: normal !important; }
        .current-focus { outline: 3px solid #2563eb; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.4); z-index: 20; position: relative; border-radius: 2px; }

        .highlight-mode {
            font-size: 1rem; line-height: 2; color: #1e293b; font-family: serif; white-space: pre-wrap; width: 100%; height: 100%; overflow: auto;
        }

        /* Tooltip */
        #tooltip {
            display: none; position: fixed; background: #1e293b; color: white;
            padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; z-index: 3000;
            white-space: pre-wrap; max-width: 300px; line-height: 1.5;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); pointer-events: none;
        }
        
        .drag-overlay { pointer-events: none; transition: opacity 0.2s; }

        /* AIæ€è€ƒåŠ¨ç”» */
        .typing-indicator span {
            animation: blink 1.4s infinite both;
            height: 6px; width: 6px; background-color: #4f46e5; border-radius: 50%; display: inline-block; margin: 0 1px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: .2; } 20% { opacity: 1; } 100% { opacity: .2; } }

        /* æ‰“å°ä¿®å¤ V41 (Full Page) */
        @media print {
            @page { margin: 1.5cm; size: auto; }
            body, html, #root { 
                height: auto !important; 
                min-height: 100% !important;
                width: 100% !important; 
                overflow: visible !important; 
                background: white !important; 
                display: block !important; 
                position: relative !important; 
            }
            /* Hide all UI except main content */
            header, aside, .resizer, .tools-footer, .no-print, .loading-overlay, .modal-overlay, .progress-bar-container, .ai-chat-window, .tools-header, .diff-header { display: none !important; }
            
            .print-main-editor { 
                display: block !important; 
                position: static !important; 
                width: 100% !important; 
                height: auto !important; 
                overflow: visible !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                border: none !important; 
                box-shadow: none !important; 
                flex: none !important;
            }
            /* Fix overflow clipping for multi-page print */
            .print-main-editor > div, .print-main-editor .group, .print-main-editor .rounded-xl { 
                position: static !important; 
                height: auto !important; 
                width: 100% !important; 
                overflow: visible !important; 
                border: none !important; 
                padding: 0 !important; 
                margin: 0 !important; 
                box-shadow: none !important; 
                display: block !important;
            }
            .print-main-editor textarea, .print-main-editor .highlight-mode { 
                display: block !important; 
                position: static !important; 
                height: auto !important; 
                width: 100% !important; 
                overflow: visible !important; 
                white-space: pre-wrap !important; 
                font-size: 12pt !important; 
                line-height: 1.6 !important; 
                color: black !important; 
            }
            
            /* Ensure filtered lists print correctly */
            .print-main-editor .filter-list-mode { 
                display: block !important; 
                height: auto !important; 
                overflow: visible !important; 
            }
            .diff-system-container { position: static !important; height: auto !important; overflow: visible !important; display: block !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        @keyframes progress-stripe { 0% { background-position: 1rem 0; } 100% { background-position: 0 0; } }
        .animate-stripe { background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem; animation: progress-stripe 1s linear infinite; }

        .markdown-body { font-size: 0.85rem; color: #334155; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: 700; color: #1e293b; margin-top: 0.3em; margin-bottom: 0.1em; font-size: 0.9rem; line-height: 1.2; }
        .markdown-body p { margin-bottom: 0.2em !important; line-height: 1.3 !important; }
        .markdown-body ul { padding-left: 1em; list-style: disc; margin-bottom: 0.2em; }
        .markdown-body li { margin-bottom: 0em; }
        .markdown-body strong { font-weight: 600; color: #0f172a; }
        .markdown-body blockquote { border-left: 2px solid #cbd5e1; padding-left: 0.5em; color: #64748b; margin: 0.2em 0; }
        .markdown-body br { display: none; } 
        
        .diff-del { background-color: #fee2e2; color: #b91c1c; text-decoration: line-through; padding: 0 2px; border-radius: 2px; }
        .diff-add { background-color: #dcfce7; color: #15803d; padding: 0 2px; border-radius: 2px; }

    </style>
</head>
<body>
    <div id="root"></div>
    <div id="tooltip"></div>
    

    <script>
        // --- ç¹ç®€å¼‚æ—§å°å­—è¯è¡¨ (å­—è¯è¡¨) ---
        // V36: Copied from V35
        const scToTcMap = {
            "çˆ±": "æ„›", "ç¢": "ç¤™", "è‚®": "éª¯", "è¢„": "è¥–", "å": "å£©", "æ¿": "é—†", "åŠ": "è¾¦", "å¸®": "å¹«", "å®": "å¯¶", "æŠ¥": "å ±",
        };
        
        const tcToScMap = {};
        (function initMaps() {
            for (let sc in scToTcMap) {
                const tc = scToTcMap[sc];
                if (Array.isArray(tc)) {
                    tc.forEach(t => tcToScMap[t] = sc);
                } else {
                    tcToScMap[tc] = sc;
                }
            }
        })();

        const variantMap = {
            "è­ª": "è—¹", "è“­": "åºµ", "æ˜»": "æ˜‚", "ç¿¶": "ç¿±", "ç¿º": "ç¿±", "æŠœ": "æ‹”", "è¦‡": "éœ¸", "æ ¢": "æŸ", "é‚«": "é‚¦", "å¯³": "å¯¶", 
        };

        const oldToNewMap = {
            "åª¼": "åªª", "å¥§": "å¥¥", "å‰": "å‰¥", "é€¬": "è¿¸", "åˆ¥": "åˆ«", "é¤ ": "é¤…", "å¹·": "å¹¶", "å€‚": "ä½µ", "å†Š": "å†Œ", "å‰": "åˆ¹", 
        };

        const confusionPhrases = {
            "å¹²å˜‰": "ä¹¾å˜‰", "å¹¹å˜‰": "ä¹¾å˜‰", "è«–è‘—": "è«–è‘—", "è®ºç€": "è«–è‘—", "é–‘äºº": "é–’äºº", "é—´äºº": "é–’äºº", "é–¤ä¸‹": "é–£ä¸‹", "åˆä¸‹": "é–£ä¸‹",
        };

        const confusionChars = {
            "å¹²": "æ˜“æ··æ·†å­—ã€‚\nã€ä¹¾ã€‘ï¼šä¹¾ç‡¥ã€ä¹¾æ·¨ã€ä¹¾è„†ã€ä¹¾ç³§\nã€å¹¹ã€‘ï¼šå¹¹éƒ¨ã€å¹¹æ´»ã€æ¨¹å¹¹ã€éª¨å¹¹ã€è»€å¹¹\nã€å¹²ã€‘ï¼šå¹²æ¶‰ã€å¹²æˆˆã€å¹²ä¼‘ã€è‹¥å¹²ã€å¤©å¹²",
        };

        const scConfusionMap = {
            "å¹²å˜‰": "ä¹¾å˜‰", "å¹²éš†": "ä¹¾éš†", "åº·å¹²": "åº·ä¹¾", "é›å¹²": "é›ä¹¾",
            "è®ºç€": "è«–è‘—", "ç€æœ‰": "è‘—æœ‰", "ç€ã€Š": "è‘—ã€Š", "ã€‹ç€": "è‘—ã€Š", "ç€ä½œ": "è‘—ä½œ",
            "é—´äºº": "é–’äºº", "æ‚ é—´": "æ‚ é–’", "æ¸…é—´": "æ¸…é–’",
            "åˆä¸‹": "é–£ä¸‹", "å‡ºåˆ": "å‡ºé–£", "åˆé—¨": "é–£é–€"
        };

        const wordFailMap = {
            "å°æ¹¾": "è‡ºç£", "é‡‡èŠ±": "æ¡èŠ±", "ä¸€å‡ºæˆ": "ä¸€é½£æˆ²", "åˆšæ‰": "å‰›çº”", 
            "å é¢†": "ä½”é ˜", "èˆå¼ƒ": "æ¨æ£„", "å‡†å¤‡": "å‡–å‚™", "èƒ¡å­": "é¬å­", "å²©çŸ³": "å·–çŸ³",
            "å°ç£": "è‡ºç£", "ä¸€å‡ºæˆ²": "ä¸€é½£æˆ²", "å‰›æ‰": "å‰›çº”", "å é ˜": "ä½”é ˜",
            "èˆæ£„": "æ¨æ£„", "å‡†å‚™": "æº–å‚™", "é¬å­": "é¬å­", "å²©çŸ³": "å·–çŸ³" 
        };

        const taiwanMap = {
            "é—œéµå­—": "å…³é”®è¯", "å­—å…ƒ": "å­—ç¬¦", "å­—å‹å¤§å°": "å­—å·", "è¨˜è™Ÿ": "æ ‡è®°", 
        };
    </script>

    <script type="text/babel">
        const { useState, useRef, useCallback, useEffect, useMemo } = React;

        const Icons = {
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Database: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Chat: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            Diff: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 15l6-6"/><path d="M11 6L3 14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2L13 6"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
            Undo: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>,
            RotateCcw: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            ArrowsLeftRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
        };

        const API_PROVIDERS = {
            deepseek: { name: "DeepSeek", baseUrl: "https://api.deepseek.com", models: ["deepseek-chat", "deepseek-coder"] },
            gemini: { name: "Google Gemini", baseUrl: "https://generativelanguage.googleapis.com/v1beta", models: ["gemini-2.0-flash-exp", "gemini-1.5-pro", "gemini-1.5-flash"] },
            openai: { name: "OpenAI", baseUrl: "https://api.openai.com/v1", models: ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo"] },
            doubao: { name: ":Doubao (è±†åŒ…)", baseUrl: "https://ark.cn-beijing.volces.com/api/v3", models: ["ep-2024..."] },
            qwen: { name: "Qwen (é€šä¹‰åƒé—®)", baseUrl: "https://dashscope.aliyuncs.com/compatible-mode/v1", models: ["qwen-plus", "qwen-max"] },
            kimi: { name: "Kimi (Moonshot)", baseUrl: "https://api.moonshot.cn/v1", models: ["moonshot-v1-8k"] },
            longcat: { name: "Longcat (é¾™çŒ«)", baseUrl: "https://api.longcat.chat/v1", models: ["longcat-v1"] }
        };

        const STATIC_TOOLS = [
            { name: "å›½å­¦å¤§å¸ˆ", url: "www.39017.com" },
            { name: "å­—ç»Ÿç½‘", url: "https://zi.tools/" }, { name: "ä¸‡å¹´å†", url: "https://www.zdic.net/ts/fulu/wnl/" },
            { name: "å­—é‰´", url: "https://api.shufashibie.com/page/index.html" }, 
            { name: "ä»¥è§‚ä¹¦æ³•", url: "https://web.ygsf.com/" },
            { name: "æœéŸµç¬ºæ³¨", url: "https://sou-yun.cn/AllusionInfer.aspx" }, { name: "å¤æ–‡å²›", url: "https://www.gushiwen.cn/" },
            { name: "å¥ç« é˜", url: "https://www.wenxianxue.cn/list.html" }, { name: "æ±‰ç±å½±åƒ", url: "https://guji.wenxianxue.cn/index" },
            { name: "ä¹¦ç›®å¾ªè¯", url: "https://gj.library.sh.cn/index" }, { name: "ä¸­åå¤ç±", url: "http://read.nlc.cn/thematDataSearch/toGujiIndex" },
            { name: "è¯†å…¸å¤ç±", url: "https://www.shidianguji.com/" }, { name: "çœ‹å…¸å¤ç±", url: "https://kandianguji.com/" },
            { name: "ç™¾åº¦ç½‘ç›˜", url: "https://pan.baidu.com/disk/main?from=homeFlow#/im/session" },
            { name: "ç™¾åº¦", url: "https://www.baidu.com" }, { name: "é¾™çŒ«", url: "https://longcat.chat/" },
        ];

        const DEFAULT_CAT = `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHBhdGggZmlsbD0iI2U1ZTdiIiBkPSJNMTIgNDRzLTItMTYgNi0yMmMwIDAgMy05IDggLTlzNSA4IDUgOGw2IDBzNS04IDUtOHM4IDkgOCA5czggNiA2IDIyWiIvPjxwYXRoIGZpbGw9IiM1YjU1NTEiIGQ9Ik0xNCA0NmMwIDAgMi0xMCAxMC0xMHMxNCA4IDE0IDhzLTEyLTItMTåäºŒZTItMTIgNC0xMiA0WiIvPjY2lyY2xlIGN4PSIyMiIgY3k9IjM2IiByPSIzIiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iNDIiIGN5PSIzNiIgcj0iMyIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==`;

        const CREDENTIALS = { "admin": "20251122", "ctxtyz": "913601", "guest": "2025" };

        const PROMPTS = {
            grammar: "ã€ç—…å¥æ£€æŸ¥ã€‘è¯·ä»”ç»†æ£€æŸ¥ä»¥ä¸‹æ–‡æœ¬ä¸­çš„è¯­ç—…ï¼ˆå¦‚æ­é…ä¸å½“ã€æˆåˆ†æ®‹ç¼ºã€è¯­åºä¸å½“ã€é€»è¾‘é”™è¯¯ç­‰ï¼‰ã€‚å¿½ç•¥æ‰€æœ‰æ ‡ç‚¹ç¬¦å·ã€é”™åˆ«å­—é—®é¢˜ã€‚\nè¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š\n1. âŒ åŸæ–‡ï¼š[æŒ‡å‡ºé—®é¢˜å¥å­]\n2. âœ… ä¿®æ”¹ï¼š[ç»™å‡ºä¿®æ”¹åçš„å¥å­]\n3. ğŸ’¡ åŸå› ï¼š[ç®€è¦è¯´æ˜ç—…å› ]\nå¦‚æœæ–‡æœ¬é€šé¡ºä¸”æœªå‘ç°æ˜æ˜¾è¯­ç—…ï¼Œè¯·ç›´æ¥å›ç­”â€œæœªå‘ç°æ˜æ˜¾è¯­ç—…â€ã€‚",
            mark_errors: "è¯·å®Œå…¨ä¿æŒåŸæ–‡å†…å®¹å’Œæ ¼å¼ï¼Œä»…å°†ä½ å‘ç°çš„é”™è¯¯ã€å»ºè®®ä¿®æ”¹å¤„ç”¨HTMLæ ‡ç­¾åŒ…è£¹ï¼šå»ºè®®ä¿®æ”¹ç”¨ <mark>åŸæ–‡</mark>ï¼Œå»ºè®®åˆ é™¤ç”¨ <del>åŸæ–‡</del>ï¼Œå»ºè®®æ–°å¢ç”¨ <ins>æ–°æ–‡</ins>ã€‚ç›´æ¥è¾“å‡ºHTMLå­—ç¬¦ä¸²ï¼Œä¸¥ç¦Markdownã€‚",
            gemini_consistency: `ã€ä¸€è‡´æ€§æ£€æŸ¥ã€‘æ£€æŸ¥æœ¯è¯­ç»Ÿä¸€ã€é€»è¾‘è¿è´¯ã€äººååœ°åä¸€è‡´æ€§ã€‚å¿½ç•¥æ ‡ç‚¹å’Œé”™åˆ«å­—ã€‚å¦‚æœæŸé¡¹æœªå‘ç°é—®é¢˜ï¼Œè¯·ç›´æ¥è¾“å‡ºâ€œé¡¹ç›®åï¼šæœªå‘ç°ã€‚â€ï¼Œä¸è¦è¾“å‡ºå¤šä½™åºŸè¯ã€‚`,
            check_corruption: `ã€æ–‡å­—é”™è®¹ã€‘è¯·ä¸¥æ ¼æ£€æŸ¥æ–‡æœ¬ä¸­çš„è„±æ¼ã€è®¹è¯¯ã€è¡æ–‡ã€å€’æ–‡ã€‚å¿½ç•¥æ ‡ç‚¹ç¬¦å·é—®é¢˜ã€‚è‹¥æ— é—®é¢˜ï¼Œè¯·ç®€å†™ä¸ºâ€œæœªå‘ç°â€ã€‚`,
            punctuation: `ã€æ ‡ç‚¹é—®é¢˜ã€‘è¯·åªæ£€æŸ¥æ ‡ç‚¹ç¬¦å·ï¼šä¸­è¥¿æ–‡æ··ç”¨ã€ä¸é—­åˆã€å ç”¨ã€å¥æœ«ç¼ºå¤±ã€‚å¿½ç•¥ä»»ä½•é”™åˆ«å­—ã€ç—…å¥æˆ–å†…å®¹é—®é¢˜ã€‚è¯·ä¸¥æ ¼åŒºåˆ†ä»¥ä¸‹ä¸‰ç±»é”™è¯¯ï¼Œå¹¶æŒ‰æ ¼å¼è¾“å‡ºï¼š\n1. ã€ç ´å¥ã€‘(å½±å“æ–‡æ„ç†è§£ã€æ­§ä¹‰ã€æ–­å¥é”™è¯¯)\n2. ã€å¯¹ç§°ã€‘(å‰åç¬¦å·ç¼ºå¤±ã€åµŒå¥—é”™è¯¯ï¼Œå¦‚ã€Šã€‹â€œâ€)\n3. ã€å…¶ä»–ã€‘(å…¶ä»–æ ‡ç‚¹é—®é¢˜)\nä¸è¦æŠ¥å‘Šå¯æ”¹å¯ä¸æ”¹çš„æ ‡ç‚¹ã€‚`,
            punctuation_broken: `ã€ç ´å¥æ£€æŸ¥ã€‘è¯·ä¸“æ³¨äºæ£€æŸ¥å½±å“æ–‡æ„ç†è§£çš„â€œç ´å¥â€é—®é¢˜ï¼ˆå¦‚å¥è¯»é”™è¯¯å¯¼è‡´æ­§ä¹‰ï¼‰ã€‚è¯·åˆ—å‡ºåŸæ–‡ã€ä¿®æ”¹æ„è§å’Œç†ç”±ã€‚ä¸è¦æŠ¥å‘Šå¯æ–­å¯ä¸æ–­çš„æƒ…å†µã€‚ä¸è¦æ£€æŸ¥é”™åˆ«å­—ã€‚`,
            punctuation_symmetric: `ã€å¯¹ç§°æ ‡ç‚¹æ£€æŸ¥ã€‘è¯·ä¸“æ³¨äºæ£€æŸ¥æˆå¯¹å‡ºç°çš„æ ‡ç‚¹ç¬¦å·ï¼ˆå¦‚ã€Šã€‹ã€ˆã€‰ã€Œã€ã€ã€â€œâ€""ï¼ˆï¼‰[]ã€ã€‘{}ç­‰ï¼‰ã€‚è¯·æŒ‡å‡ºç¼ºå¤±å¦ä¸€åŠã€å‰åç¬¦å·ç”¨åæˆ–åµŒå¥—é”™è¯¯çš„åœ°æ–¹ã€‚ä¸è¦æ£€æŸ¥é”™åˆ«å­—ã€‚`,
            fact: "ã€äº‹å®æ ¸æŸ¥ã€‘æ ¸å®å¹´ä»£ã€æ•°æ®ã€äººåã€åœ°åã€‚",
            logic: "ã€é€»è¾‘æ£€æŸ¥ã€‘æ£€æŸ¥æ–‡ç« è®ºè¯é€»è¾‘æ˜¯å¦ä¸¥å¯†ï¼Œæ˜¯å¦å­˜åœ¨å‰åçŸ›ç›¾ã€‚",
            ai_char_check: `ã€ç¹ç®€å­—æ£€æŸ¥ã€‘è¯·æ£€æŸ¥æ–‡æœ¬ä¸­çš„ç¹ç®€å­—æ··ç”¨ã€å¼‚ä½“å­—é”™è¯¯ã€å°æ¹¾ç”¨è¯­æ··å…¥ç­‰é—®é¢˜ã€‚`,
            ai_content_check: `ã€å†…å®¹å…¨é¢æ ¸æŸ¥ã€‘è¯·å¯¹æ–‡æœ¬è¿›è¡Œå…¨æ–¹ä½çš„æ£€æŸ¥ï¼ŒåŒ…æ‹¬ï¼š1.æ–‡å­—é”™è®¹ 2.æ ‡ç‚¹é—®é¢˜ 3.ç—…å¥ 4.ä¸€è‡´æ€§ã€‚è¯·åˆ†ç‚¹åˆ—å‡ºå‘ç°çš„é—®é¢˜ã€‚`,
            ai_detect: "ã€AI æ£€æµ‹ã€‘è¯·åˆ†æè¿™æ®µæ–‡æœ¬æ˜¯å¦ç”±AIç”Ÿæˆï¼Œå¹¶ç»™å‡ºç½®ä¿¡åº¦å’Œç†ç”±ã€‚",
            ai_rewrite: "ã€å»å‘³é™é‡ã€‘è¯·å¯¹æ–‡æœ¬è¿›è¡Œæ”¹å†™ï¼Œå»é™¤AIå‘³ï¼Œé™ä½æŸ¥é‡ç‡ï¼Œä½¿å…¶æ›´è‡ªç„¶ã€‚",
            rewrite_plain: "ã€å¹³å®æ¶¦è‰²ã€‘è¯·ç”¨å¹³å®ã€é€šä¿—çš„è¯­è¨€æ¶¦è‰²è¿™æ®µæ–‡æœ¬ï¼Œå»é™¤æµ®å¤¸è¾è—»ã€‚",
            rewrite_academic: "ã€å­¦æœ¯æ¶¦è‰²ã€‘è¯·ç”¨å­¦æœ¯è§„èŒƒçš„è¯­è¨€æ¶¦è‰²è¿™æ®µæ–‡æœ¬ï¼Œä½¿å…¶æ›´ä¸¥è°¨ã€ä¸“ä¸šã€‚",
            summary_short: "ã€ç²¾ç®€æ‘˜è¦ã€‘200å­—æ¦‚æ‹¬ã€‚", summary_long: "ã€è¯¦ç»†å½’çº³ã€‘1000å­—åˆ†ç‚¹å½’çº³ã€‚",
            eval_short: "ã€çŸ­è¯„ã€‘300å­—è¯„ä»·ã€‚", eval_long: "ã€é•¿è¯„ã€‘1000å­—æ·±åº¦å‰–æã€‚",
        };

        const obfuscate = (s) => { if (!s) return ""; const salt = s.split('').map(c => c + Math.random().toString(36).substring(2, 5)).join(''); return 'V29_' + btoa(salt).split('').reverse().join(''); };
        const deobfuscate = (s) => { if (!s) return ""; if (s.startsWith('V29_')) { const raw = atob(s.substring(4).split('').reverse().join('')); let res = ""; for (let i = 0; i < raw.length; i += 4) res += raw[i]; return res; } try { return atob(s).split('').filter((_, i) => i % 2 === 0).reverse().join(''); } catch(e) { return s; } };

        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        const performLocalCheck = (text, mode) => {
            let html = "";
            let count = 0;
            let replacementCount = 0;
            
            const scanPhrases = (map, cls, prefix) => {
                let res = ""; let c = 0; let i = 0;
                while(i < text.length) {
                    let matched = false;
                    for(let len=6; len>=2; len--) {
                        if(i+len <= text.length) {
                            const sub = text.substr(i, len);
                            if(map.hasOwnProperty(sub)) {
                                res += `<span class="${cls}" data-suggestion="${prefix}${map[sub]}">${sub}</span>`;
                                i+=len; matched=true; c++; break;
                            }
                        }
                    }
                    if(!matched) { res += escapeHtml(text[i]); i++; }
                }
                return {html: res, count: c};
            };

            if (['s2t', 't2s', 'old2new', 'variant_old_to_new'].includes(mode)) {
                let resText = "";
                let i = 0;
                while(i < text.length) {
                    const char = text[i];
                    let replacement = null;
                    if (mode === 's2t' && typeof scToTcMap !== 'undefined' && scToTcMap.hasOwnProperty(char)) {
                        const val = scToTcMap[char];
                        replacement = Array.isArray(val) ? `<span class="highlight-uncertain" data-suggestion="ä¸ç¡®å®šï¼š${val.join(' / ')}">${char}</span>` : val;
                    } else if (mode === 't2s' && typeof tcToScMap !== 'undefined' && tcToScMap.hasOwnProperty(char)) {
                        replacement = tcToScMap[char];
                    } else if (mode === 'old2new' && typeof oldToNewMap !== 'undefined' && oldToNewMap.hasOwnProperty(char)) {
                        replacement = oldToNewMap[char];
                    } else if (mode === 'variant_old_to_new') {
                        if (typeof oldToNewMap !== 'undefined' && oldToNewMap.hasOwnProperty(char)) replacement = oldToNewMap[char];
                        else if (typeof variantMap !== 'undefined' && variantMap.hasOwnProperty(char)) replacement = variantMap[char];
                    }
                    
                    if (replacement) {
                        resText += replacement;
                        replacementCount++;
                    } else {
                        resText += escapeHtml(char);
                    }
                    i++;
                }
                return { html: resText, count: replacementCount, isConversion: true, key: mode };
            }

            if (['find-sc', 'find-tc', 'find-variant', 'find-old'].includes(mode)) {
                let i = 0;
                while(i < text.length) {
                    const char = text[i];
                    let matched = false; let sug = ""; let cls = ""; let pre = "";
                    if (mode === 'find-sc' && typeof scToTcMap !== 'undefined' && scToTcMap.hasOwnProperty(char)) { sug = Array.isArray(scToTcMap[char]) ? scToTcMap[char].join(' æˆ– ') : scToTcMap[char]; cls = "highlight-sc"; pre = "å»ºè®®ç¹ä½“ï¼š"; matched = true; } 
                    else if (mode === 'find-tc' && typeof tcToScMap !== 'undefined' && tcToScMap.hasOwnProperty(char)) { sug = tcToScMap[char]; cls = "highlight-tc"; pre = "å»ºè®®ç®€ä½“ï¼š"; matched = true; } 
                    else if (mode === 'find-variant' && typeof variantMap !== 'undefined' && variantMap.hasOwnProperty(char)) { sug = variantMap[char]; cls = "highlight-variant"; pre = "å»ºè®®ï¼š"; matched = true; } 
                    else if (mode === 'find-old' && typeof oldToNewMap !== 'undefined' && oldToNewMap.hasOwnProperty(char)) { sug = oldToNewMap[char]; cls = "highlight-old"; pre = "å»ºè®®æ–°å­—å½¢ï¼š"; matched = true; }

                    if(matched) { html += `<span class="${cls}" data-suggestion="${pre}${sug}">${char}</span>`; count++; } else { html += escapeHtml(char); }
                    i++;
                }
            } else if (mode === 'find-confusion') {
                if (typeof confusionPhrases !== 'undefined' && typeof confusionChars !== 'undefined') {
                    let i = 0;
                    while (i < text.length) {
                        let matched = false;
                        for (let len = 4; len >= 2; len--) {
                            const sub = text.substr(i, len);
                            if (confusionPhrases.hasOwnProperty(sub)) {
                                html += `<span class="highlight-confusion-error" data-suggestion="ç¡®å®šé”™è¯¯ï¼Œå»ºè®®ï¼š${confusionPhrases[sub]}">${sub}</span>`;
                                i += len; matched = true; count++; break;
                            }
                        }
                        if (!matched) {
                            if (confusionChars.hasOwnProperty(text[i])) {
                                html += `<span class="highlight-confusion-suspect" data-suggestion="${confusionChars[text[i]]}">${text[i]}</span>`;
                                count++;
                            } else html += escapeHtml(text[i]);
                            i++;
                        }
                    }
                } else { html = escapeHtml(text); }
            } else {
                let map, cls, pre;
                if (mode === 'find-sc-error' && typeof scConfusionMap !== 'undefined') { map = scConfusionMap; cls = "highlight-sc-error"; pre = "å»ºè®®ä¿®æ­£ï¼š"; }
                else if (mode === 'find-word-fail' && typeof wordFailMap !== 'undefined') { map = wordFailMap; cls = "highlight-word-fail"; pre = "Wordæœªè½¬ç¹ä½“ï¼Œå»ºè®®ï¼š"; }
                else if (typeof taiwanMap !== 'undefined' && mode === 'find-taiwan') { map = taiwanMap; cls = "highlight-taiwan"; pre = "ç–‘ä¼¼å°æ¹¾è¯æ±‡ï¼Œå»ºè®®å¤§é™†ç”¨è¯­ï¼š"; }
                else { map = {}; cls=""; pre=""; }
                const res = scanPhrases(map, cls, pre);
                html = res.html; count = res.count;
            }
            return {html, count, isConversion: false, key: mode};
        };

        const Button = ({ onClick, icon: Icon, label, variant = 'primary', className = '', disabled = false }) => {
            const variants = {
                primary: "bg-[#2563eb] text-white hover:bg-[#1d4ed8] border-transparent",
                secondary: "bg-white text-slate-700 border-slate-200 hover:bg-slate-50",
                danger: "bg-red-50 text-red-600 border-red-200 hover:bg-red-100",
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium border transition-all disabled:opacity-50 ${variants[variant]} ${className}`}>
                    {Icon && <Icon />} {label && <span className="truncate">{label}</span>}
                </button>
            );
        };

        const ProgressBar = ({ progress, label }) => (
            <div className="w-full mb-4 progress-bar-container animate-in fade-in slide-in-from-top-2">
                <div className="flex justify-between text-xs mb-1 font-bold text-blue-600">
                    <span>{label || "å¤„ç†ä¸­..."}</span>
                    <span>{progress}%</span>
                </div>
                <div className="w-full bg-blue-100 rounded-full h-2 overflow-hidden">
                    <div className="bg-blue-500 h-2 rounded-full transition-all duration-300 animate-stripe" style={{ width: `${progress}%` }}></div>
                </div>
            </div>
        );

        const Modal = ({ title, onClose, children, headerAction }) => (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-[2px] p-4 animate-in fade-in no-print modal-overlay">
                <div className="w-full max-w-lg rounded-xl bg-white shadow-2xl max-h-[90vh] flex flex-col border border-gray-100">
                    <div className="flex items-center justify-between border-b px-5 py-4 rounded-t-xl bg-white sticky top-0 z-10">
                        <h3 className="text-lg font-bold text-gray-800">{title}</h3>
                        <div className="flex items-center gap-2">
                            {headerAction}
                            <button onClick={onClose} className="rounded-full p-1 hover:bg-gray-100 text-gray-500"><Icons.X /></button>
                        </div>
                    </div>
                    <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                </div>
            </div>
        );

        const ChatWindow = ({ onClose, contextText, contextResults, onCallAI, mainApiConfig }) => {
            const [messages, setMessages] = useState([{role: 'ai', content: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ã€‚æˆ‘å·²ç»é˜…è¯»äº†å½“å‰æ–‡æ¡£å’Œæ£€æŸ¥ç»“æœï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ ï¼Ÿ'}]);
            const [input, setInput] = useState("");
            const [isSending, setIsSending] = useState(false);
            const chatEndRef = useRef(null);
            const [position, setPosition] = useState({ x: window.innerWidth - 420, y: window.innerHeight - 600 });
            const [isDragging, setIsDragging] = useState(false);
            const offset = useRef({ x: 0, y: 0 });
            const chatRef = useRef(null);
            
            // V40 Config Fix
            const [showConfig, setShowConfig] = useState(false);
            const [chatApiConfig, setChatApiConfig] = useState({
                useIndependent: false,
                provider: 'deepseek',
                apiKey: '',
                model: 'deepseek-chat'
            });

            useEffect(() => chatEndRef.current?.scrollIntoView({ behavior: "smooth" }), [messages]);
            
            const handleMouseDown = useCallback((e) => {
                if (!e.target.closest('.chat-header')) return; 
                setIsDragging(true);
                const rect = chatRef.current.getBoundingClientRect();
                offset.current = { x: e.clientX - rect.left, y: e.clientY - rect.top };
                e.preventDefault();
            }, []);

            const handleMouseMove = useCallback((e) => {
                if (!isDragging) return;
                let newX = e.clientX - offset.current.x;
                let newY = e.clientY - offset.current.y;
                const maxX = window.innerWidth - (chatRef.current?.offsetWidth || 400);
                const maxY = window.innerHeight - (chatRef.current?.offsetHeight || 500);
                setPosition({ x: Math.max(0, Math.min(newX, maxX)), y: Math.max(0, Math.min(newY, maxY)) });
            }, [isDragging]);

            const handleMouseUp = useCallback(() => setIsDragging(false), []);

            useEffect(() => {
                if (isDragging) { window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp); }
                return () => { window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp); };
            }, [isDragging, handleMouseMove, handleMouseUp]);

            const handleSend = async () => {
                if (!input.trim()) return;
                const userMsg = { role: 'user', content: input };
                setMessages(prev => [...prev, userMsg]);
                setInput("");
                setIsSending(true);

                try {
                    const resPrompt = contextResults.map(r => `[æ£€æŸ¥ç±»å‹:${r.type}] ${r.content}`).join('\n');
                    const context = `å½“å‰æ–‡æ¡£å†…å®¹ï¼ˆå‰2000å­—ï¼‰ï¼š\n${contextText.slice(0, 2000)}\n\nå·²æœ‰æ£€æŸ¥ç»“æœï¼š\n${resPrompt}`;
                    
                    let aiResponse = "";
                    setMessages(prev => [...prev, { role: 'ai', content: <div className="typing-indicator"><span></span><span></span><span></span></div>, isThinking: true }]);

                    if (chatApiConfig.useIndependent && chatApiConfig.apiKey) {
                         const pData = API_PROVIDERS[chatApiConfig.provider];
                         const m = chatApiConfig.model || pData.models[0];
                         if (chatApiConfig.provider === 'gemini') {
                            const url = `${pData.baseUrl}/models/${m}:generateContent?key=${chatApiConfig.apiKey}`;
                            const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: `è¯·åŸºäºä»¥ä¸‹æ–‡æ¡£èƒŒæ™¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚\n\n${context}\n\nç”¨æˆ·é—®é¢˜ï¼š${userMsg.content}` }] }] }) });
                            const data = await res.json(); aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Fail";
                         } else {
                            const url = `${pData.baseUrl}/chat/completions`;
                            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${chatApiConfig.apiKey}` }, body: JSON.stringify({ model: m, messages: [{role: "user", content: `è¯·åŸºäºä»¥ä¸‹æ–‡æ¡£èƒŒæ™¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚\n\n${context}\n\nç”¨æˆ·é—®é¢˜ï¼š${userMsg.content}`}] }) });
                            const data = await res.json(); aiResponse = data.choices[0].message.content;
                         }
                    } else {
                        aiResponse = await onCallAI(`è¯·åŸºäºä»¥ä¸‹æ–‡æ¡£èƒŒæ™¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚\n\n${context}\n\nç”¨æˆ·é—®é¢˜ï¼š${userMsg.content}`);
                    }
                    
                    setMessages(prev => [...prev.filter(m => !m.isThinking), { role: 'ai', content: aiResponse }]);
                } catch (e) {
                    setMessages(prev => [...prev.filter(m => !m.isThinking), { role: 'ai', content: "å‡ºé”™: " + e.message }]);
                } finally { setIsSending(false); }
            };

            return (
                <div ref={chatRef} className={`fixed w-[400px] h-[600px] bg-white rounded-xl shadow-2xl border border-indigo-100 z-[200] flex flex-col ai-chat-window animate-in resize overflow-hidden`} style={{left: `${position.x}px`, top: `${position.y}px`}}>
                    <div className="flex flex-col border-b bg-indigo-600 text-white rounded-t-xl cursor-move chat-header" onMouseDown={handleMouseDown}>
                        <div className="flex justify-between items-center p-3">
                            <span className="font-bold text-sm flex items-center gap-2"><Icons.Chat/> AI å¯¹è¯åŠ©æ‰‹</span>
                            <div className="flex items-center gap-2">
                                <button onClick={()=>setShowConfig(!showConfig)} className="hover:bg-indigo-700 p-1 rounded text-xs border border-indigo-400" onMouseDown={e=>e.stopPropagation()}>{showConfig ? 'æ”¶èµ·é…ç½®' : 'ç‹¬ç«‹API'}</button>
                                <button onClick={onClose} className="hover:bg-indigo-700 p-1 rounded" onMouseDown={e=>e.stopPropagation()}><Icons.X/></button>
                            </div>
                        </div>
                        {showConfig && (
                            <div className="px-3 pb-3 bg-indigo-700 pt-2 text-xs space-y-2" onMouseDown={e=>e.stopPropagation()}>
                                <div className="flex items-center gap-2">
                                    <input type="checkbox" checked={chatApiConfig.useIndependent} onChange={e=>setChatApiConfig({...chatApiConfig, useIndependent: e.target.checked})} id="useIndep" />
                                    <label htmlFor="useIndep">å¯ç”¨ç‹¬ç«‹é…ç½® (æœªå¯ç”¨åˆ™ä½¿ç”¨ä¸»é…ç½®)</label>
                                </div>
                                {chatApiConfig.useIndependent && (
                                    <>
                                        <div className="flex gap-2">
                                            <select className="text-black rounded p-1 flex-1" value={chatApiConfig.provider} onChange={e => setChatApiConfig({...chatApiConfig, provider: e.target.value, model: API_PROVIDERS[e.target.value].models[0]})}>
                                                {Object.entries(API_PROVIDERS).map(([k, v]) => <option key={k} value={k}>{v.name}</option>)}
                                            </select>
                                            <select className="text-black rounded p-1 flex-1" value={chatApiConfig.model} onChange={e => setChatApiConfig({...chatApiConfig, model: e.target.value})}>
                                                {API_PROVIDERS[chatApiConfig.provider]?.models.map(m => <option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                        <input type="password" placeholder="ç‹¬ç«‹API Key" className="text-black px-2 py-1 rounded w-full" value={chatApiConfig.apiKey} onChange={e=>setChatApiConfig({...chatApiConfig, apiKey: e.target.value})} />
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                    <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                <div className={`max-w-[85%] p-2 rounded-lg text-sm ${m.role==='user'?'bg-indigo-600 text-white':'bg-white border border-slate-200 text-slate-700'}`}>
                                    {m.content}
                                </div>
                            </div>
                        ))}
                        <div ref={chatEndRef} />
                    </div>
                    <div className="p-3 border-t bg-white h-auto shrink-0">
                        <div className="flex gap-2">
                            <textarea className="flex-1 border rounded px-2 py-1 text-sm outline-none focus:border-indigo-500 resize-y h-16 min-h-[40px] max-h-[150px]" value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSend()}}} placeholder="è¾“å…¥é—®é¢˜..." />
                            <button onClick={handleSend} disabled={isSending} className="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 disabled:opacity-50 h-10 self-end">å‘é€</button>
                        </div>
                    </div>
                </div>
            );
        };

        // V41: Restored V36 Layout for DiffSystem
        const DiffSystem = ({ apiConfig, onClose }) => {
            const [oldText, setOldText] = useState("");
            const [newText, setNewText] = useState("");
            const [diffData, setDiffData] = useState([]);
            const [summary, setSummary] = useState({ adds: 0, dels: 0, changes: 0 });
            const [isCompared, setIsCompared] = useState(false);
            
            const handleDualDrop = async (e, type) => {
                e.preventDefault(); e.stopPropagation();
                const file = e.dataTransfer.files[0];
                if (!file) return;
                
                let content = "";
                if (/\.docx$/i.test(file.name)) {
                    const ab = await file.arrayBuffer();
                    const r = await mammoth.extractRawText({ arrayBuffer: ab });
                    content = r.value;
                } else if (/\.pdf$/i.test(file.name)) {
                     alert("PDFæš‚ä¸æ”¯æŒå¯¹æ¯”æ¨¡å¼ï¼Œè¯·å¤åˆ¶æ–‡æœ¬"); return;
                } else {
                    content = await new Promise(resolve => {
                        const r = new FileReader(); r.onload = ev => resolve(ev.target.result); r.readAsText(file);
                    });
                }
                if (type === 'old') setOldText(content); else setNewText(content);
            };

            const handleSwap = () => {
                const temp = oldText;
                setOldText(newText);
                setNewText(temp);
            };

            const handleCompare = () => {
                if (!window.Diff) return alert("Diffåº“æœªåŠ è½½");
                const diffFn = window.Diff.diffSentences || window.Diff.diffLines; 
                const diffs = diffFn(oldText, newText);
                let a=0, d=0; diffs.forEach(p => { if(p.added) a++; if(p.removed) d++; });
                setDiffData(diffs);
                setSummary({ adds: a, dels: d, changes: a+d });
                setIsCompared(true);
            };

            return (
                <div className="flex flex-col h-full bg-[#f3f4f6] diff-system-container">
                    <div className="p-2 border-b flex items-center justify-between bg-white shadow-sm flex-none">
                        <div className="flex items-center gap-4">
                            <button onClick={onClose} className="px-3 py-1 bg-white border rounded hover:bg-gray-100 text-sm font-bold flex items-center gap-1"><Icons.ArrowLeft/> è¿”å›ä¸»é¡µ</button>
                            <h2 className="text-lg font-bold text-gray-700 flex items-center gap-2"><Icons.Diff /> æ–‡æ¡£æ™ºèƒ½æ¯”å¯¹</h2>
                        </div>
                        <div className="flex gap-2">
                            <button className="px-3 py-1.5 bg-purple-50 text-purple-600 rounded border border-purple-200 text-xs font-bold hover:bg-purple-100 flex items-center gap-1"><Icons.Zap /> æ™ºèƒ½æ€»ç»“</button>
                            <button className="px-3 py-1.5 bg-white text-gray-600 rounded border border-gray-200 text-xs font-bold hover:bg-gray-50 flex items-center gap-1"><Icons.List /> ç”Ÿæˆæ—¥å¿—</button>
                            <button onClick={()=>window.print()} className="px-3 py-1.5 bg-white text-gray-600 rounded border border-gray-200 text-xs font-bold hover:bg-gray-50 flex items-center gap-1"><Icons.Download /> æ‰“å°/å¯¼å‡º</button>
                            <button onClick={handleCompare} className="bg-blue-600 text-white px-6 py-1.5 rounded font-bold hover:bg-blue-700 shadow-sm text-xs flex items-center gap-1"><Icons.Play /> å¼€å§‹æ¯”å¯¹</button>
                        </div>
                    </div>
                    
                    <div className="flex flex-1 overflow-hidden p-4 gap-4">
                        <div className="w-1/3 flex flex-col gap-4 h-full">
                            <div className="flex-1 flex flex-col relative bg-white rounded-xl shadow-sm border overflow-hidden group" onDragOver={e=>e.preventDefault()} onDrop={e=>handleDualDrop(e, 'old')}>
                                <div className="px-4 py-2 bg-blue-50 border-b border-blue-100 text-xs font-bold text-blue-700 flex justify-between items-center">
                                    <span>åŸæ–‡ (Old)</span>
                                    <div className="flex gap-2"><button className="hover:underline text-blue-500">ä¸Šä¼ </button><button onClick={()=>setOldText('')} className="hover:underline text-red-400">æ¸…ç©º</button></div>
                                </div>
                                <textarea className="flex-1 w-full p-4 resize-none text-sm bg-transparent outline-none font-mono" placeholder="è¾“å…¥åŸæ–‡æˆ–æ‹–å…¥ä¸¤ä¸ªæ–‡ä»¶..." value={oldText} onChange={e=>setOldText(e.target.value)}></textarea>
                            </div>
                            
                            <div className="h-0 relative flex justify-center items-center z-10">
                                <button onClick={handleSwap} className="bg-white border shadow-md p-1.5 rounded-full hover:bg-blue-50 text-blue-600 transition transform hover:rotate-180" title="äº¤æ¢å†…å®¹">
                                    <Icons.ArrowsLeftRight />
                                </button>
                            </div>

                            <div className="flex-1 flex flex-col relative bg-white rounded-xl shadow-sm border overflow-hidden group" onDragOver={e=>e.preventDefault()} onDrop={e=>handleDualDrop(e, 'new')}>
                                <div className="px-4 py-2 bg-green-50 border-b border-green-100 text-xs font-bold text-green-700 flex justify-between items-center">
                                    <span>æ–°æ–‡ (New)</span>
                                    <div className="flex gap-2"><button className="hover:underline text-green-600">ä¸Šä¼ </button><button onClick={()=>setNewText('')} className="hover:underline text-red-400">æ¸…ç©º</button></div>
                                </div>
                                <textarea className="flex-1 w-full p-4 resize-none text-sm bg-transparent outline-none font-mono" placeholder="è¾“å…¥æ–°æ–‡..." value={newText} onChange={e=>setNewText(e.target.value)}></textarea>
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col gap-4 h-full">
                            <div className="h-24 flex gap-4 flex-none">
                                <div className="flex-1 bg-white rounded-xl p-4 border-l-4 border-yellow-400 shadow-sm">
                                    <div className="text-xs text-gray-500 font-bold">å·®å¼‚ç‚¹</div><div className="text-3xl font-bold text-slate-800">{summary.changes}</div>
                                </div>
                                <div className="flex-1 bg-white rounded-xl p-4 border-l-4 border-green-500 shadow-sm">
                                    <div className="text-xs text-gray-500 font-bold">æ–°å¢</div><div className="text-3xl font-bold text-slate-800">{summary.adds}</div>
                                </div>
                                <div className="flex-1 bg-white rounded-xl p-4 border-l-4 border-red-500 shadow-sm">
                                    <div className="text-xs text-gray-500 font-bold">åˆ é™¤</div><div className="text-3xl font-bold text-slate-800">{summary.dels}</div>
                                </div>
                            </div>

                            <div className="flex-1 bg-white rounded-xl shadow-sm border overflow-hidden flex flex-col relative p-6">
                                {!isCompared ? (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-400">
                                        <Icons.Diff />
                                        <p className="mt-4 text-sm font-medium">å‡†å¤‡å°±ç»ªï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’â€œå¼€å§‹æ¯”å¯¹â€</p>
                                    </div>
                                ) : (
                                    <div className="flex-1 overflow-y-auto space-y-2 font-mono text-sm leading-relaxed">
                                        {diffData.map((part, i) => (
                                            <div key={i} className={`p-2 rounded border ${part.added ? 'bg-green-50 border-green-100 text-green-900' : part.removed ? 'bg-red-50 border-red-100 text-red-900 opacity-70' : 'border-transparent text-gray-600'}`}>
                                                {part.added && <span className="text-xs font-bold text-green-600 block mb-1">æ–°å¢</span>}
                                                {part.removed && <span className="text-xs font-bold text-red-600 block mb-1">åˆ é™¤</span>}
                                                <span className={part.removed ? 'line-through' : ''}>{part.value}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const LoginModal = ({ onLogin, onCancel }) => {
            const [u, setU] = useState("");
            const [p, setP] = useState("");
            const [remember, setRemember] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem("tianzhen_auth");
                if(saved) {
                    const creds = JSON.parse(saved);
                    setU(creds.u); setP(atob(creds.p)); setRemember(true);
                }
            }, []);

            const handleLogin = () => {
                if (CREDENTIALS[u] === p) {
                    if(remember) localStorage.setItem("tianzhen_auth", JSON.stringify({u, p: btoa(p)}));
                    else localStorage.removeItem("tianzhen_auth");
                    onLogin(u);
                } else alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
            };

            return (
                <div className="fixed inset-0 z-[120] flex items-start pt-40 justify-center bg-black/50 modal-overlay">
                    <div className="bg-white rounded-lg p-6 w-80 shadow-2xl animate-in slide-in-from-top-10">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">ç³»ç»Ÿç™»å½•</h3>
                            <button onClick={()=>alert("è¯·è”ç³»ç®¡ç†å‘˜")} className="text-xs text-blue-600 hover:underline">ä½¿ç”¨è¯´æ˜</button>
                        </div>
                        <input className="w-full border rounded p-2 mb-3 text-sm" placeholder="è´¦å·" value={u} onChange={e=>setU(e.target.value)} />
                        <input className="w-full border rounded p-2 mb-4 text-sm" type="password" placeholder="å¯†ç " value={p} onChange={e=>setP(e.target.value)} />
                        <div className="flex items-center mb-4">
                            <input type="checkbox" id="rememberMe" checked={remember} onChange={e=>setRemember(e.target.checked)} className="mr-2" />
                            <label htmlFor="rememberMe" className="text-xs text-gray-600 cursor-pointer">è®°ä½å¯†ç </label>
                        </div>
                        <div className="flex justify-end gap-2">
                            <Button label="å–æ¶ˆ" variant="secondary" onClick={onCancel} />
                            <Button label="ç™»å½•" onClick={handleLogin} />
                        </div>
                    </div>
                </div>
            );
        };

        const AboutModal = ({ onClose }) => (
            <div className="fixed inset-0 z-[130] flex items-center justify-center bg-black/40 backdrop-blur-[2px] p-4 animate-in fade-in no-print modal-overlay">
                <div className="bg-white rounded-xl shadow-2xl p-8 text-center max-w-sm">
                     <h3 className="text-xl font-bold mb-4 text-indigo-600">å…³äºæœ¬è½¯ä»¶</h3>
                     <p className="text-gray-700 font-medium mb-2">æœ¬è½¯ä»¶ç”±æŸ˜äººå‡ºå“ï¼ŒçŒ®ç»™å°è––çªä¸»äºº</p>
                     <p className="text-gray-500 text-sm mb-4">è¯¦æƒ…è”ç³» ccc.1@qq.com</p>
                     <p className="text-gray-400 text-xs mb-6">API ç§˜é’¥è¯·è‡ªè¡Œç”³è¯·</p>
                     <Button label="å…³é—­" onClick={onClose} className="w-full" />
                </div>
            </div>
        );


        // --- Main App ---

        function App() {
            const [fileName, setFileName] = useState("æœªå‘½åæ–‡æ¡£");
            const [wordCount, setWordCount] = useState(0);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0); 
            const [loadingText, setLoadingText] = useState("");      
            const [cancelPdf, setCancelPdf] = useState(null);
            
            const [isMarking, setIsMarking] = useState(false);
            const [results, setResults] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [showAbout, setShowAbout] = useState(false);
            const [showChat, setShowChat] = useState(false);
            const [currentUser, setCurrentUser] = useState("");
            const [initialConfig, setInitialConfig] = useState(""); 

            const [initialContent, setInitialContent] = useState(""); 
            const [highlightContent, setHighlightContent] = useState(""); 
            const [isHighlightMode, setIsHighlightMode] = useState(false);
            const [isDragging, setIsDragging] = useState(false); 
            const [strictness, setStrictness] = useState(3); 
            const [lastCommand, setLastCommand] = useState(null);
            
            const [navIndex, setNavIndex] = useState(0);
            const [navTotal, setNavTotal] = useState(0);
            const [filterMode, setFilterMode] = useState('all'); 
            const [showSuspects, setShowSuspects] = useState(true); 
            const [errorSentences, setErrorSentences] = useState([]); 

            const [knowledgeBase, setKnowledgeBase] = useState([]);
            const [isKbActive, setIsKbActive] = useState(false); 
            const [showKnowledgeList, setShowKnowledgeList] = useState(false);
            
            const [diffMode, setDiffMode] = useState(false);
            const [activeFeature, setActiveFeature] = useState(""); 
            
            const [leftPanelWidth, setLeftPanelWidth] = useState(240);
            const [rightPanelWidth, setRightPanelWidth] = useState(420);
            const [isResizingLeft, setIsResizingLeft] = useState(false);
            const [isResizingRight, setIsResizingRight] = useState(false);
            
            const [preConversionContent, setPreConversionContent] = useState("");

            const editorRef = useRef(null);
            const fileInputRef = useRef(null);
            const kbInputRef = useRef(null);
            const avatarInputRef = useRef(null);
            const configImportRef = useRef(null);
            const mainContainerRef = useRef(null);
            const dragCounter = useRef(0);

            const [apiConfig, setApiConfig] = useState(() => {
                const defaultCfg = { provider: 'deepseek', apiKey: '', model: 'deepseek-chat', notebook: "", avatar: DEFAULT_CAT, customTools: [{name:'',url:''}, {name:'',url:''}, {name:'',url:''}] };
                try {
                    const saved = localStorage.getItem('tianzhen_config_v22'); 
                    if (saved) {
                        const temp = JSON.parse(saved);
                        if (temp.apiKey && !temp.apiKey.startsWith('sk-')) temp.apiKey = deobfuscate(temp.apiKey);
                        if (temp.notebook && temp.notebook.startsWith('V29_')) temp.notebook = deobfuscate(temp.notebook);
                        if (!temp.customTools || !Array.isArray(temp.customTools)) temp.customTools = defaultCfg.customTools; 
                        if (!temp.avatar || temp.avatar.length < 100) temp.avatar = DEFAULT_CAT;
                        return { ...defaultCfg, ...temp };
                    }
                } catch(e) { console.error(e); }
                return defaultCfg;
            });
            
            // Auto Login Check
            useEffect(() => {
                const saved = localStorage.getItem("tianzhen_auth");
                if(saved) {
                    const creds = JSON.parse(saved);
                    if (CREDENTIALS[creds.u] === atob(creds.p)) setCurrentUser(creds.u);
                }
            }, []);

            const updateEditorContent = useCallback((txt) => {
                setInitialContent(txt); setWordCount(txt.length);
                if(editorRef.current) editorRef.current.value = txt;
                setIsHighlightMode(false); 
                setNavTotal(0); setErrorSentences([]); setFilterMode('all');
            }, []);

            const processFile = useCallback(async (file) => {
                if (!file) return;
                setFileName(file.name);
                if (/\.docx$/i.test(file.name)) {
                    if (!window.mammoth) return alert("MammothæœªåŠ è½½");
                    const ab = await file.arrayBuffer();
                    mammoth.extractRawText({ arrayBuffer: ab }).then(r => updateEditorContent(r.value));
                } else if (/\.doc$/i.test(file.name)) {
                    const reader = new FileReader();
                    reader.onload = (e) => updateEditorContent("[å…¼å®¹æ¨¡å¼] å·²æå– .doc æ–‡æœ¬ï¼š\n" + e.target.result.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F-\x9F]/g, ""));
                    reader.readAsBinaryString(file);
                } else if (/\.pdf$/i.test(file.name)) {
                    setIsLoading(true); setLoadingText("æ­£åœ¨è§£æ PDF...");
                    let cancelled = false; setCancelPdf(() => () => { cancelled = true; });
                    try {
                        const ab = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(ab).promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            if (cancelled) throw new Error("ç”¨æˆ·å–æ¶ˆ");
                            setLoadingText(`æ­£åœ¨è§£æ PDF ç¬¬ ${i} / ${pdf.numPages} é¡µ...`);
                            setLoadingProgress(Math.round((i / pdf.numPages) * 100));
                            const page = await pdf.getPage(i);
                            const tc = await page.getTextContent();
                            fullText += tc.items.map(item => item.str).join(" ") + "\n";
                        }
                        updateEditorContent(fullText);
                    } catch (e) { if(e.message !== "ç”¨æˆ·å–æ¶ˆ") alert("PDF è§£æå¤±è´¥: " + e.message); } 
                    finally { setIsLoading(false); setCancelPdf(null); }
                } else {
                    const reader = new FileReader();
                    reader.onload = e => updateEditorContent(e.target.result);
                    reader.readAsText(file);
                }
            }, [updateEditorContent]);

            const handleKbUpload = async (e) => {
                const files = Array.from(e.target.files);
                let newDocs = [];
                for (const file of files) {
                    let content = await new Promise(resolve => {
                        const r = new FileReader(); r.onload = ev => resolve(ev.target.result); r.readAsText(file);
                    });
                    newDocs.push({ name: file.name, content: content, summary: "ç­‰å¾…å­¦ä¹ ..." });
                }
                setKnowledgeBase(prev => [...prev, ...newDocs]);
                alert(`å·²æ·»åŠ  ${newDocs.length} ä¸ªæ–‡æ¡£`);
            };

            const activateKb = async () => {
                setIsKbActive(true);
                alert("è®°å¿†åº“å·²æ¿€æ´»ï¼ŒAIå°†å‚è€ƒè¿™äº›å†…å®¹ã€‚");
            };

            // V41: Enhanced Filter
            const handlePunctuationFilter = (type) => {
                const container = document.querySelector('.highlight-mode');
                if(!container) return;
                container.classList.remove('show-only-broken', 'show-only-symmetric', 'show-only-other');
                if (type === 'broken') container.classList.add('show-only-broken');
                else if (type === 'symmetric') container.classList.add('show-only-symmetric');
                else if (type === 'other') container.classList.add('show-only-other');
            };

            useEffect(() => {
                const handleDragEnter = (e) => { e.preventDefault(); e.stopPropagation(); if(!diffMode) dragCounter.current++; if(dragCounter.current > 0 && !diffMode) setIsDragging(true); };
                const handleDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); if(!diffMode) dragCounter.current--; if(dragCounter.current === 0) setIsDragging(false); };
                const handleDragOver = (e) => { e.preventDefault(); e.stopPropagation(); };
                const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); dragCounter.current = 0; if (!diffMode && e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); };
                window.addEventListener('dragenter', handleDragEnter); window.addEventListener('dragleave', handleDragLeave); window.addEventListener('dragover', handleDragOver); window.addEventListener('drop', handleDrop);
                return () => { window.removeEventListener('dragenter', handleDragEnter); window.removeEventListener('dragleave', handleDragLeave); window.removeEventListener('dragover', handleDragOver); window.removeEventListener('drop', handleDrop); };
            }, [diffMode, processFile]);

            const handleCloseSettings = () => {
                const current = JSON.stringify(apiConfig);
                if (current !== initialConfig) {
                    if (window.confirm("é…ç½®å·²æ›´æ”¹ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ")) handleSaveSettings(); else { setApiConfig(JSON.parse(initialConfig)); setShowSettings(false); }
                } else setShowSettings(false);
            };

            const handleSaveSettings = () => {
                localStorage.setItem('tianzhen_config_v22', JSON.stringify({ ...apiConfig, apiKey: obfuscate(apiConfig.apiKey) }));
                setShowSettings(false);
            };

            const callAI = async (prompt) => {
                const { provider, apiKey, model } = apiConfig;
                if (provider === 'simulated') return new Promise(r => setTimeout(() => r("ã€æ¼”ç¤ºæ¨¡å¼ã€‘API æœªé…ç½®ã€‚"), 2000));
                if (!apiKey) throw new Error("è¯·å…ˆé…ç½® API Key");
                const pData = API_PROVIDERS[provider];
                const m = model || pData.models[0];
                if (provider === 'gemini') {
                    const url = `${pData.baseUrl}/models/${m}:generateContent?key=${apiKey}`;
                    const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    const data = await res.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text || "Fail";
                } else {
                    const url = `${pData.baseUrl}/chat/completions`;
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: m, messages: [{role: "user", content: prompt}] }) });
                    const data = await res.json(); return data.choices[0].message.content;
                }
            };

            // V41: Fix - Clean sentence extraction for "Filter Sentences" mode
            // This extracts pure HTML while removing data-attributes that might leak to UI
            const parseErrorSentences = (html) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Clean data attributes from the temp DOM
                tempDiv.querySelectorAll('*').forEach(el => {
                    el.removeAttribute('data-suggestion');
                    el.removeAttribute('class'); // Optional: remove classes if strict text needed, but we want highlights
                    // Re-add minimal classes for highlight
                    if(el.tagName === 'MARK' || el.tagName === 'DEL' || el.tagName === 'INS') {
                        // Keep structural tags
                    } else if(el.tagName === 'SPAN' && el.outerHTML.includes('highlight-')) {
                        // Keep span highlights but strip tooltip data
                        // Logic handles by just taking innerHTML of sentence context
                    }
                });

                const errors = document.createElement('div');
                errors.innerHTML = html; // Re-parse for finding locations
                const errorElements = errors.querySelectorAll('[class^="highlight-"], mark, del, ins');
                const list = [];
                
                errorElements.forEach((el, idx) => {
                    // We use the original HTML to find context, but we'll need to clean the output
                    let parent = el.parentElement;
                    let contextHtml = "";
                    
                    if (parent && (parent.tagName === 'P' || parent.tagName === 'DIV' || parent.tagName === 'LI')) {
                         // Get full line HTML
                         contextHtml = parent.innerHTML;
                    } else {
                        contextHtml = el.outerHTML;
                    }
                    
                    // Cleaning Step for the Display List
                    // Remove data-suggestion attributes from the snippet string
                    contextHtml = contextHtml.replace(/data-suggestion="[^"]*"/g, "");
                    
                    // Ensure it's not too long
                    if (contextHtml.length > 300) {
                        const needle = el.innerHTML; // approximate match
                        const idx = contextHtml.indexOf(needle);
                        const start = Math.max(0, idx - 50);
                        const end = Math.min(contextHtml.length, idx + needle.length + 100);
                        contextHtml = "..." + contextHtml.substring(start, end) + "...";
                    }

                    list.push({ id: idx + 1, html: contextHtml });
                });
                return list;
            };

            const executeFeature = async (key, label, isRegen = false) => {
                const text = isHighlightMode ? initialContent : (editorRef.current?.value || "");
                if (!text.trim()) return alert("è¯·å…ˆè¾“å…¥å†…å®¹");
                if (!isRegen) { setLastCommand({ key, label }); setActiveFeature(key); } 

                const localModes = ['find-sc', 'find-tc', 'find-confusion', 'find-sc-error', 'find-variant', 'find-old', 'find-word-fail', 'find-taiwan', 's2t', 't2s', 'old2new', 'variant_old_to_new'];
                
                if (localModes.includes(key)) {
                    if (['s2t', 't2s', 'old2new', 'variant_old_to_new'].includes(key)) {
                        setPreConversionContent(text);
                    }

                    setIsLoading(true); setLoadingText(`å¤„ç†ä¸­ï¼š${label}`); setLoadingProgress(50);
                    setTimeout(() => {
                        const res = performLocalCheck(text, key);
                        setHighlightContent(res.html); setIsHighlightMode(true);
                        setNavTotal(res.count); setNavIndex(res.count>0?1:0);
                        setErrorSentences(parseErrorSentences(res.html)); 
                        
                        setLoadingProgress(100); setIsLoading(false);
                        
                        // V41: Better success message for conversions
                        if (res.isConversion) {
                             setResults(prev => [{ id: Date.now(), type: `[æœ¬åœ°] ${label}`, content: `å·²ä¿®æ”¹ ${res.count} å¤„ã€‚`, timeStr: new Date().toLocaleTimeString(), duration: "0.1", tokens: 0, strictness: "æœ¬åœ°", rawPrompt: text, key: key }, ...prev]);
                        } else if (res.count > 0) {
                            setResults(prev => [{ id: Date.now(), type: `[æœ¬åœ°] ${label}`, content: `å‘ç° ${res.count} å¤„é—®é¢˜ã€‚`, timeStr: new Date().toLocaleTimeString(), duration: "0.1", tokens: 0, strictness: "æœ¬åœ°", rawPrompt: text, key: key }, ...prev]);
                        } else alert(`${label}ï¼šæœªå‘ç°æ˜æ˜¾é—®é¢˜ã€‚`);
                    }, 200);
                    return;
                }
                
                setIsLoading(true); setLoadingText(`AI åˆ†æï¼š${label}`); setLoadingProgress(0);
                const timer = setInterval(() => setLoadingProgress(p => p>=90?p:p+5), 500);
                const start = Date.now();
                
                try {
                    let sysPrompt = `ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯è¾…åŠ©åŠ©æ‰‹ã€‚æ ‡å‡†ï¼š${["","å®½æ¾","è¾ƒå®½","é€‚ä¸­","è¾ƒä¸¥","ä¸¥æ ¼"][strictness]}ã€‚`;
                    if (isKbActive) sysPrompt += `\nã€å‚è€ƒè®°å¿†åº“ã€‘ï¼š\n${knowledgeBase.map(k=>k.content.slice(0,300)).join('\n')}`;
                    
                    const promptText = PROMPTS[key] || "è¯·åˆ†æï¼š";
                    const content = await callAI(`${sysPrompt}\n\n${promptText}\n\n${text.slice(0, 40000)}`);
                    
                    clearInterval(timer); setLoadingProgress(100); setIsLoading(false);
                    const tokens = text.length + content.length;
                    
                    if (!content.includes("æœªå‘ç°")) {
                        setResults(prev => [{ id: Date.now(), type: label, content, timeStr: new Date().toLocaleTimeString(), duration: ((Date.now()-start)/1000).toFixed(1), tokens, strictness: ["","å®½æ¾","è¾ƒå®½","é€‚ä¸­","è¾ƒä¸¥","ä¸¥æ ¼"][strictness], rawPrompt: text, key: key }, ...prev]);
                    } else alert(`${label}ï¼šæœªå‘ç°æ˜æ˜¾é—®é¢˜ã€‚`);
                } catch (err) { clearInterval(timer); setIsLoading(false); alert("Error: " + err.message); } 
            };
            
            const handleMarkOriginal = async (resItem) => {
                if(!resItem || !resItem.rawPrompt) return;
                setIsMarking(true); setIsLoading(true); setLoadingText("åŸæ–‡æ ‡è®°ä¸­(AIå¤„ç†è¾ƒæ…¢è¯·ç¨å€™)...");
                
                if (resItem.type.startsWith("[æœ¬åœ°]")) {
                    const res = performLocalCheck(resItem.rawPrompt, resItem.key);
                    setHighlightContent(res.html); setIsHighlightMode(true);
                    setNavTotal(res.count); setErrorSentences(parseErrorSentences(res.html));
                    setIsLoading(false); setIsMarking(false); return;
                }
                try {
                    let prompt = PROMPTS['mark_errors'];
                    if (resItem.key === 'punctuation') {
                        prompt = "è¯·ä»…æ ‡è®°æ ‡ç‚¹ç¬¦å·é”™è¯¯ã€‚å¿½ç•¥æ‰€æœ‰é”™åˆ«å­—ã€è¯­æ³•é—®é¢˜ã€‚ç ´å¥ç”¨ <mark class='highlight-broken'>åŸæ–‡</mark>ï¼Œå¯¹ç§°é”™è¯¯ç”¨ <mark class='highlight-symmetric'>åŸæ–‡</mark>ï¼Œå…¶ä»–æ ‡ç‚¹é—®é¢˜ç”¨ <mark class='highlight-other'>åŸæ–‡</mark>ã€‚ç›´æ¥è¾“å‡ºå®Œæ•´HTMLã€‚";
                    } else if (resItem.key === 'check_corruption') {
                        prompt = "è¯·ä»…æ ‡è®°æ–‡å­—è„±æ¼ã€è®¹è¯¯ã€‚å¿½ç•¥æ ‡ç‚¹ç¬¦å·ã€‚";
                    } 

                    const html = await callAI(`è¾“å‡ºçº¯HTMLã€‚\n${prompt}\n\nåŸæ–‡ï¼š\n${resItem.rawPrompt}\n\næ„è§ï¼š\n${resItem.content}`);
                    const cleanHtml = html.replace(/```html/g,'').replace(/```/g,'').trim();
                    setHighlightContent(cleanHtml); setIsHighlightMode(true);
                    setErrorSentences(parseErrorSentences(cleanHtml)); 
                    const count = (cleanHtml.match(/<mark|<del|<ins/g) || []).length;
                    setNavTotal(count);
                } catch(e) { alert("æ ‡è®°å¤±è´¥"); } 
                finally { setIsLoading(false); setIsMarking(false); }
            };

            const resize = useCallback((e) => {
                if (!mainContainerRef.current) return;
                const r = mainContainerRef.current.getBoundingClientRect();
                if (isResizingLeft) setLeftPanelWidth(Math.min(Math.max(e.clientX - r.left, 200), 450));
                if (isResizingRight) setRightPanelWidth(Math.min(Math.max(r.right - e.clientX, 350), 800));
            }, [isResizingLeft, isResizingRight]);
            
            useEffect(() => {
                if(isResizingLeft || isResizingRight) {
                    window.addEventListener("mousemove", resize); window.addEventListener("mouseup", () => { setIsResizingLeft(false); setIsResizingRight(false); });
                }
                return () => window.removeEventListener("mousemove", resize);
            }, [isResizingLeft, isResizingRight, resize]);

            const handleNav = (dir) => {
                const elements = document.querySelectorAll('.highlight-mode span[class^="highlight-"], .highlight-mode mark, .highlight-mode del, .highlight-mode ins');
                if (elements.length === 0) return;
                elements.forEach(el => el.classList.remove('current-focus'));
                let newIndex = navIndex + dir;
                if (newIndex < 1) newIndex = elements.length;
                if (newIndex > elements.length) newIndex = 1;
                setNavIndex(newIndex);
                elements[newIndex - 1].classList.add('current-focus');
                elements[newIndex - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
            };
            
            const handleRestoreInitial = () => {
                if(confirm("ç¡®å®šè¦å¤åŸåˆ°æœ€åˆä¸Šä¼ çš„çŠ¶æ€å—ï¼Ÿæ‰€æœ‰æ›´æ”¹å°†ä¸¢å¤±ã€‚")) {
                    updateEditorContent(initialContent); 
                }
            };
            
            const handleUndoConversion = () => {
                if (preConversionContent) {
                    setHighlightContent(performLocalCheck(preConversionContent, 'noop').html); 
                    updateEditorContent(preConversionContent);
                    setPreConversionContent("");
                }
            };

            const SIDEBAR_ITEMS = [
                { title: "å­—å¥ä¸å†…å®¹æ ¸æŸ¥", rows: [[{k:'check_corruption',l:'æ–‡å­—é”™è®¹'}, {k:'punctuation',l:'æ ‡ç‚¹é—®é¢˜'}], [{k:'grammar',l:'æ£€æŸ¥ç—…å¥'}, {k:'gemini_consistency',l:'æ£€æŸ¥ä¸€è‡´æ€§'}], [{k:'fact',l:'äº‹å®æŸ¥é”™'}, {k:'logic',l:'é€»è¾‘æ£€æŸ¥'}]] },
                { title: "å­—å½¢æ£€æŸ¥ä¸è½¬æ¢", rows: [[{k:'find-sc',l:'ç¹ä¸­æ‰¾ç®€'}, {k:'find-tc',l:'ç®€ä¸­æ‰¾ç¹'}], [{k:'find-confusion',l:'æ˜“é”™ç¹ä½“'}, {k:'find-sc-error',l:'æ˜“é”™ç®€ä½“'}], [{k:'find-variant',l:'æ‰¾å¼‚ä½“å­—'}, {k:'find-old',l:'æ‰¾æ—§å­—å½¢'}], [{k:'find-word-fail',l:'å¤±è½¬ç¹ä½“'}, {k:'find-taiwan',l:'ä¸¤å²¸å¼‚è¯'}], [{k:'s2t',l:'ç®€è½¬ç¹'}, {k:'t2s',l:'ç¹è½¬ç®€'}, {k:'old2new',l:'æ—§è½¬æ–°'}, {k:'variant_old_to_new',l:'å¼‚è½¬æ­£'}]] },
                { title: "AI æ£€æµ‹ä¸æ¶¦è‰²", rows: [[{k:'ai_detect',l:'AI æ£€æµ‹'}, {k:'ai_rewrite',l:'å»å‘³é™é‡'}], [{k:'rewrite_plain',l:'å¹³å®æ¶¦è‰²'}, {k:'rewrite_academic',l:'å­¦æœ¯æ¶¦è‰²'}]] },
                { title: "AI æ‘˜è¦ä¸è¯„ä»·", rows: [[{k:'summary_short',l:'ç²¾ç®€æ‘˜è¦(200)'}, {k:'summary_long',l:'è¯¦ç»†å½’çº³(1k)'}], [{k:'eval_short',l:'çŸ­è¯„(300)'}, {k:'eval_long',l:'é•¿è¯„(1k)'}]] }
            ];

            return (
                <div className="flex h-screen w-full flex-col bg-[#f8fafc] text-slate-800 overflow-hidden">
                    {isDragging && !diffMode && <div className="absolute inset-0 z-[90] flex items-center justify-center bg-blue-600/10 backdrop-blur-sm border-4 border-blue-500 border-dashed m-4 rounded-2xl drag-overlay"><div className="bg-white p-10 rounded-3xl shadow-2xl flex flex-col items-center animate-bounce"><div className="text-blue-500 mb-4 scale-150"><Icons.Upload /></div><h2 className="text-2xl font-bold text-gray-700">æ¾å¼€é¼ æ ‡ä¸Šä¼ æ–‡æ¡£</h2></div></div>}

                    <header className="flex h-16 flex-none items-center justify-between border-b bg-white px-4 shadow-sm z-20 no-print">
                        <div className="flex items-center gap-3">
                            <img src={apiConfig.avatar} className="h-10 w-10 rounded-full border-2 border-indigo-100 object-cover" />
                            <h1 className="text-xl font-bold text-slate-800 tracking-tight">å¤©çAIæ–‡æ¡£åŠ©æ‰‹ <span className="ml-1 rounded-md bg-indigo-50 px-2 py-0.5 text-xs font-semibold text-indigo-600">V41</span></h1>
                            {currentUser && <div onClick={()=>{if(confirm('ç¡®å®šé€€å‡ºç™»å½•ï¼Ÿ')) setCurrentUser("");}} className="ml-4 flex items-center gap-1 px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs cursor-pointer hover:bg-red-50 hover:text-red-600 transition" title="ç‚¹å‡»é€€å‡º"><span className="w-2 h-2 bg-green-500 rounded-full"></span><span className="font-bold">{currentUser}</span></div>}
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={()=>executeFeature('ai_content_check', 'AIä¸€é”®æŸ¥å†…å®¹')} className="border border-slate-300 text-sm font-bold text-slate-700 bg-white hover:text-indigo-600 hover:border-indigo-300 px-3 py-1.5 rounded-md shadow-sm transition">AI ä¸€é”®æŸ¥å†…å®¹</button>
                            <button onClick={()=>executeFeature('ai_char_check', 'AIä¸€é”®æŸ¥å­—å½¢')} className="border border-slate-300 text-sm font-bold text-slate-700 bg-white hover:text-indigo-600 hover:border-indigo-300 px-3 py-1.5 rounded-md shadow-sm transition">AI ä¸€é”®æŸ¥å­—å½¢</button>
                            <div className="flex items-center gap-2 text-xs font-bold text-green-700 bg-green-50 px-3 py-1.5 rounded-full border border-green-200">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> {API_PROVIDERS[apiConfig.provider]?.name || 'åœ¨çº¿'}
                            </div>
                            <Button label="é…ç½®" icon={Icons.Settings} variant="secondary" onClick={()=>{ if(!currentUser) setShowLogin(true); else { setInitialConfig(JSON.stringify(apiConfig)); setShowSettings(true); } }} />
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden" ref={mainContainerRef}>
                        {diffMode ? <DiffSystem apiConfig={apiConfig} onClose={() => setDiffMode(false)} /> : (
                        <>
                        <aside className="flex flex-col border-r bg-white overflow-hidden no-print" style={{ width: leftPanelWidth }}>
                            <div className="flex-1 overflow-y-auto p-3 scrollbar-hide">
                                {SIDEBAR_ITEMS.map((group, i) => (
                                    <div key={i} className="mb-2"><h4 className="text-[11px] font-bold text-slate-800 mb-1 px-1">{group.title}</h4>
                                        <div className="grid grid-cols-2 gap-1">{group.rows.map((row) => row.map(item => <button key={item.k} onClick={() => executeFeature(item.k, item.l)} className={`truncate rounded-md border border-slate-100 bg-slate-50 px-2 py-1.5 text-xs font-medium text-slate-600 transition-all hover:bg-white hover:text-blue-600 hover:border-blue-200 hover:shadow-sm text-center`}>{item.l}</button>))}</div>
                                    </div>
                                ))}
                                <button onClick={()=>setShowChat(true)} className="w-full mt-2 border border-indigo-200 bg-indigo-50 text-indigo-700 px-3 py-2 rounded-md text-sm font-bold hover:bg-indigo-100 transition shadow-sm flex items-center justify-center gap-2"><Icons.Chat/> AI å¯¹è¯</button>
                            </div>

                            <div className="p-3 border-t bg-slate-50">
                                <h4 className="text-xs font-bold text-slate-600 mb-2 flex justify-between">
                                    <span>çµçŒ«è®°å¿†åº“</span> <span className="bg-slate-200 px-1 rounded">{knowledgeBase.length}</span>
                                </h4>
                                <div className="grid grid-cols-3 gap-1">
                                    <input type="file" ref={kbInputRef} className="hidden" multiple onChange={handleKbUpload} />
                                    <Button label="ä¸Šä¼ " variant="secondary" className="!px-1 !py-1 text-[10px]" onClick={()=>kbInputRef.current.click()} />
                                    <Button label="å­¦ä¹ " variant="primary" className="!px-1 !py-1 text-[10px]" onClick={activateKb} disabled={knowledgeBase.length===0} />
                                    <Button label="åˆ—è¡¨" variant="secondary" className="!px-1 !py-1 text-[10px]" onClick={()=>setShowKnowledgeList(true)} />
                                </div>
                            </div>
                        </aside>
                        <div className="resizer no-print" onMouseDown={()=>setIsResizingLeft(true)}></div>

                        <main className="relative flex flex-col min-w-0 bg-[#f8fafc] flex-1 print-main-editor">
                            <div className="flex flex-none items-center justify-between border-b bg-white/80 px-4 py-2 backdrop-blur-sm z-10 h-10 no-print tools-header">
                                <span className="text-sm font-medium text-slate-500 break-all">{fileName}</span> 
                                <div className="flex items-center gap-2 text-xs text-slate-400">
                                    <span>{wordCount} å­—</span>
                                    {['s2t', 't2s', 'old2new', 'variant_old_to_new'].includes(activeFeature) && preConversionContent && (
                                        <>
                                            <div className="h-4 w-px bg-slate-300 mx-1"></div>
                                            <button onClick={handleUndoConversion} className="flex items-center gap-1 hover:text-blue-600"><Icons.Undo/> æ’¤é”€</button>
                                            <button onClick={() => {setHighlightContent(performLocalCheck(initialContent, activeFeature).html); setIsHighlightMode(true);}} className="flex items-center gap-1 hover:text-blue-600"><Icons.RotateCcw/> æ¢å¤</button>
                                        </>
                                    )}
                                </div>
                            </div>
                            
                            <div className="relative flex-1 p-6 overflow-hidden group">
                                {wordCount === 0 ? (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center z-10 no-print">
                                        <input type="file" ref={fileInputRef} className="hidden" onChange={(e) => { if(e.target.files.length) processFile(e.target.files[0]) }} accept=".docx,.doc,.pdf,.txt" />
                                        <div className="mb-6 flex h-16 w-16 items-center justify-center rounded-full bg-blue-50 text-blue-500"><Icons.Upload /></div>
                                        <h2 className="text-xl font-bold text-slate-800 mb-2">å¼€å§‹å†™ä½œæˆ–ä¸Šä¼ æ–‡æ¡£</h2>
                                        {/* V41: Updated Text */}
                                        <p className="text-slate-500 mb-6 text-sm">æ”¯æŒæ‹–æ‹½è§£æ .docx (Word), .txt, .md, .pdf</p>
                                        <div className="flex gap-4 mb-6"><button onClick={() => fileInputRef.current.click()} className="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-lg shadow-blue-200">ä¸Šä¼ æ–‡æ¡£</button><button onClick={() => updateEditorContent("è¿™é‡Œæ˜¯æµ‹è¯•æ–‡æœ¬...")} className="px-6 py-2 bg-white text-slate-700 border border-slate-200 rounded-lg text-sm font-medium hover:bg-slate-50">ç²˜è´´æ–‡æœ¬</button></div>
                                        <button onClick={() => setDiffMode(true)} className="flex items-center gap-2 px-4 py-1.5 rounded-full bg-indigo-50 text-indigo-600 border border-indigo-200 text-xs font-medium"><Icons.Diff /> åˆ‡æ¢åˆ°æ–‡æ¡£å¯¹æ¯”æ¨¡å¼</button>
                                    </div>
                                ) : (
                                    <div className="h-full w-full flex flex-col">
                                        <div className="flex justify-between items-center mb-2 no-print">
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => { setInitialContent(""); setHighlightContent(""); setIsHighlightMode(false); if(editorRef.current) editorRef.current.value=""; setWordCount(0); setFileName("æœªå‘½åæ–‡æ¡£"); setResults([]); }} className="hover:bg-red-50 border border-red-200 rounded px-3 py-0.5 text-red-600 bg-white shadow-sm font-medium text-xs">ç§»é™¤</button>
                                                <button onClick={handleRestoreInitial} className="hover:bg-blue-50 border border-blue-200 rounded px-3 py-0.5 text-blue-600 bg-white shadow-sm font-medium text-xs flex items-center gap-1"><Icons.RotateCcw/> å¤åŸ</button>
                                                <button onClick={() => window.print()} className="hover:bg-gray-100 border border-gray-200 rounded px-3 py-0.5 text-slate-600 bg-white shadow-sm font-medium text-xs">å¯¼å‡º</button>
                                                {cancelPdf && <Button label="å–æ¶ˆè§£æ" icon={Icons.X} variant="danger" onClick={cancelPdf} className="!py-1" />}
                                                {isHighlightMode && <Button label="å–æ¶ˆæ ‡è®°" icon={Icons.X} className="!py-1 bg-amber-100 text-amber-700 hover:bg-amber-200 border-amber-300" onClick={() => setIsHighlightMode(false)} />}
                                                
                                                {activeFeature.includes('confusion') && isHighlightMode && (
                                                    <button onClick={() => setShowSuspects(!showSuspects)} className={`text-xs px-2 py-0.5 border rounded flex items-center gap-1 transition ${showSuspects ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-gray-50 text-gray-400'}`}>
                                                        {showSuspects ? <Icons.Eye /> : <Icons.EyeOff />} {showSuspects ? 'ç–‘ä¼¼' : 'å·²éš'}
                                                    </button>
                                                )}
                                                
                                                {activeFeature === 'punctuation' && isHighlightMode && (
                                                    <>
                                                        <button onClick={()=>handlePunctuationFilter('broken')} className="text-xs px-2 py-0.5 border border-red-200 text-red-700 bg-red-50 rounded hover:bg-red-100">åªçœ‹ç ´å¥</button>
                                                        <button onClick={()=>handlePunctuationFilter('symmetric')} className="text-xs px-2 py-0.5 border border-blue-200 text-blue-700 bg-blue-50 rounded hover:bg-blue-100">åªçœ‹å¯¹ç§°æ ‡ç‚¹</button>
                                                        <button onClick={()=>handlePunctuationFilter('other')} className="text-xs px-2 py-0.5 border border-slate-200 text-slate-700 bg-slate-50 rounded hover:bg-slate-100">å…¶ä»–</button>
                                                    </>
                                                )}
                                            </div>

                                            {isHighlightMode && navTotal > 0 && (
                                                <div className="flex items-center gap-1 bg-white border border-slate-200 rounded-full px-2 py-1 shadow-sm">
                                                    <button onClick={()=>handleNav(-1)} className="p-0.5 hover:bg-gray-100 rounded text-xs text-slate-600">ä¸Šä¸€ä¸ª</button>
                                                    <span className="text-xs font-mono text-slate-500 mx-1">{navIndex}/{navTotal}</span>
                                                    <button onClick={()=>handleNav(1)} className="p-0.5 hover:bg-gray-100 rounded text-xs text-slate-600">ä¸‹ä¸€ä¸ª</button>
                                                    <button onClick={()=>setFilterMode(filterMode==='sentences'?'all':'sentences')} className={`p-0.5 rounded text-xs px-2 flex items-center gap-1 ${filterMode==='sentences'?'bg-indigo-600 text-white shadow-md':'hover:bg-gray-100 text-slate-600'}`}><Icons.Filter/> åªçœ‹è¯¯å¥</button>
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex-1 w-full rounded-xl bg-white shadow-sm border border-slate-200 p-8 overflow-hidden relative">
                                            {isHighlightMode ? (
                                                filterMode === 'sentences' ? (
                                                    <div className="h-full w-full overflow-auto highlight-mode filter-list-mode">
                                                        <ol className="list-decimal pl-6 space-y-4 font-serif">
                                                            {errorSentences.map((item, i) => (
                                                                <li key={i} className="pl-2 border-b border-gray-100 pb-2">
                                                                    <div dangerouslySetInnerHTML={{__html: item.html}}></div>
                                                                </li>
                                                            ))}
                                                        </ol>
                                                        {errorSentences.length === 0 && <p className="text-gray-400 text-center mt-10">æ— é”™è¯¯å¥å­</p>}
                                                    </div>
                                                ) : (
                                                    <div className={`h-full w-full overflow-auto highlight-mode ${!showSuspects ? 'hide-suspects' : ''}`} dangerouslySetInnerHTML={{__html: highlightContent}}></div>
                                                )
                                            ) : (
                                                <textarea ref={editorRef} defaultValue={initialContent} onInput={(e) => { setWordCount(e.target.value.length); setInitialContent(e.target.value); }} className="h-full w-full resize-none border-none bg-transparent text-base leading-loose text-slate-800 outline-none font-serif placeholder-transparent relative z-20" spellCheck="false" />
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="flex-none border-t bg-white px-3 shadow-sm z-10 h-auto py-2 flex items-center overflow-x-auto scrollbar-hide no-print tools-footer">
                                <div className="flex flex-wrap gap-2 justify-center w-full">
                                    {[...STATIC_TOOLS, ...(apiConfig.customTools || [])].filter(t=>t.name&&t.url).map((tool, i) => <a key={i} href={tool.url} target="_blank" className="flex items-center gap-1 px-2 py-1 rounded border border-slate-200 bg-white text-[11px] font-medium text-slate-600 hover:text-blue-600 hover:border-blue-300 hover:shadow-sm transition-all">{tool.name}</a>)}
                                </div>
                            </div>
                        </main>

                        <div className="resizer no-print" onMouseDown={()=>setIsResizingRight(true)}></div>

                        <aside className="flex flex-col bg-white z-10 shadow-xl no-print" style={{ width: rightPanelWidth }}>
                            <div className="flex flex-none items-center justify-between border-b px-4 py-3 bg-gray-50/80 h-14">
                                <div className="flex items-center gap-2"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icons.Zap /> æ£€æŸ¥ç»“æœ</h3>{lastCommand && <Button onClick={() => executeFeature(lastCommand.key, lastCommand.label, true)} label="é‡æ–°ç”Ÿæˆ" variant="secondary" disabled={isLoading} className="!text-xs !px-2 !py-1 ml-4" />}</div>
                                <Button onClick={() => { const blob = new Blob([results.map(r=>`[${r.type}]\n${r.content}`).join('\n\n')], {type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "report.txt"; a.click(); }} label="å¯¼å‡ºç»“æœ" variant="secondary" className="!text-xs !px-2 !py-1" />
                            </div>
                            
                            {isLoading && !cancelPdf && <div className="px-4 pt-4"><ProgressBar progress={loadingProgress} label={loadingText} /></div>}

                            <div className="px-6 py-3 border-b bg-white">
                                <div className="flex justify-between text-[10px] text-slate-400 font-bold uppercase mb-2 tracking-wide"><span>å®½æ¾</span><span>è¾ƒå®½</span><span>é€‚ä¸­</span><span>è¾ƒä¸¥</span><span>ä¸¥æ ¼</span></div>
                                <div className="relative h-4 flex items-center"><input type="range" min="1" max="5" step="1" value={strictness} onChange={(e) => setStrictness(parseInt(e.target.value))} className="w-full z-10 opacity-0 absolute" /><div className="w-full h-1 bg-slate-100 rounded-full absolute"></div><div className="w-full flex justify-between absolute px-0.5">{[1,2,3,4,5].map(i => <div key={i} className={`w-2 h-2 rounded-full ${i<=strictness ? 'bg-blue-500' : 'bg-slate-300'} transition-colors`}></div>)}</div><div className="w-4 h-4 bg-blue-600 rounded-full shadow-md absolute pointer-events-none transition-all" style={{left: `${(strictness-1)*25}%`, transform: 'translateX(-50%)'}}></div></div>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#f8fafc]">
                                {results.map((res) => (
                                    <div key={res.id} className="group relative rounded-xl border border-slate-200 bg-white p-3 shadow-sm hover:shadow-md animate-in slide-in-from-right-4">
                                        <div className="mb-2 flex items-center justify-between border-b border-slate-50 pb-2">
                                            <div className="flex items-center gap-3">
                                                <span className={`rounded px-2 py-0.5 text-xs font-bold ${res.type.includes('âœ¨')?'bg-purple-100 text-purple-700':'bg-blue-50 text-blue-700'}`}>{res.type}</span>
                                                <div className="flex items-center gap-2 text-[10px] text-slate-500 bg-slate-50 px-2 py-0.5 rounded-full font-mono border border-slate-100">
                                                    <span className="flex items-center gap-1 text-slate-400"><Icons.Clock /> {res.timeStr}</span>
                                                    {!res.type.startsWith('[æœ¬åœ°]') && <><span className="text-slate-300">|</span><span>{res.tokens} Tokens</span></>}
                                                </div>
                                            </div>
                                            {(res.key && res.key!=='s2t' && res.key!=='t2s') && <button onClick={() => handleMarkOriginal(res)} disabled={isMarking} className="text-[10px] text-amber-600 hover:bg-amber-50 px-2 py-1 rounded transition-colors font-medium">åŸæ–‡æ ‡è®°</button>}
                                        </div>
                                        <div className="markdown-body prose prose-sm max-w-none text-slate-700 font-sans whitespace-pre-wrap" dangerouslySetInnerHTML={{__html: marked.parse(res.content)}}></div>
                                    </div>
                                ))}
                            </div>
                        </aside>
                        </>
                        )}
                    </div>

                    {showLogin && <LoginModal onLogin={(u) => {setCurrentUser(u); setShowLogin(false); setInitialConfig(JSON.stringify(apiConfig)); setShowSettings(true);}} onCancel={()=>setShowLogin(false)} />}
                    {showAbout && <AboutModal onClose={()=>setShowAbout(false)} />}
                    {showChat && <ChatWindow onClose={()=>setShowChat(false)} contextText={initialContent} contextResults={results} onCallAI={callAI} mainApiConfig={apiConfig} />}

                    {showSettings && (
                        <Modal 
                            title="ç³»ç»Ÿé…ç½®" 
                            onClose={handleCloseSettings}
                            headerAction={<button onClick={()=>setShowAbout(true)} className="text-sm font-bold text-indigo-600 hover:underline mr-4">å…³äºæœ¬è½¯ä»¶</button>}
                        >
                            <div className="space-y-5">
                                <div className="flex items-center gap-4 p-4 bg-slate-50 rounded-lg border border-slate-100">
                                    <img src={apiConfig.avatar} className="h-16 w-16 rounded-full object-cover border-2 border-white shadow" />
                                    <div className="flex-1"><input type="file" accept="image/*" className="hidden" ref={avatarInputRef} onChange={(e) => { if(e.target.files[0]){ const r=new FileReader(); r.onload=ev=>setApiConfig({...apiConfig,avatar:ev.target.result}); r.readAsDataURL(e.target.files[0]); } }} /><Button label="æ›´æ¢å¤´åƒ" variant="secondary" onClick={() => avatarInputRef.current.click()} /></div>
                                </div>
                                <div className="space-y-3"><label className="block text-xs font-bold text-slate-500 uppercase">AI æœåŠ¡å•† & æ¨¡å‹</label><div className="grid grid-cols-2 gap-3"><select className="rounded border p-2 text-sm" value={apiConfig.provider} onChange={e => setApiConfig({...apiConfig, provider: e.target.value, model: API_PROVIDERS[e.target.value].models[0]})}>{Object.entries(API_PROVIDERS).map(([k, v]) => <option key={k} value={k}>{v.name}</option>)}<option value="simulated">æ¼”ç¤ºæ¨¡å¼</option></select><select className="rounded border p-2 text-sm" value={apiConfig.model} onChange={e => setApiConfig({...apiConfig, model: e.target.value})}>{apiConfig.provider !== 'simulated' && API_PROVIDERS[apiConfig.provider]?.models.map(m => <option key={m} value={m}>{m}</option>)}</select></div><input type="password" className="w-full rounded border p-2 text-sm font-mono" value={apiConfig.apiKey} placeholder="API Key..." onChange={e => setApiConfig({...apiConfig, apiKey: e.target.value})} /></div>
                                
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">å¤‡å¿˜å½•</label>
                                    <textarea className="w-full border rounded p-2 text-sm h-20 bg-yellow-50/50" value={apiConfig.notebook} onChange={e=>setApiConfig({...apiConfig, notebook: e.target.value})} placeholder="åœ¨æ­¤è®°å½•å¤‡å¿˜..." />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">è‡ªå®šä¹‰ç½‘ç«™</label>
                                    <div className="space-y-2">
                                        {[0,1,2].map(i=>(
                                            <div key={i} className="flex gap-2">
                                                <input className="border rounded p-1 text-xs w-20" placeholder="åç§°" value={apiConfig.customTools[i]?.name||''} onChange={e=>{const n=[...apiConfig.customTools]; if(!n[i])n[i]={}; n[i].name=e.target.value; setApiConfig({...apiConfig,customTools:n})}} />
                                                <input className="border rounded p-1 text-xs flex-1" placeholder="URL" value={apiConfig.customTools[i]?.url||''} onChange={e=>{const n=[...apiConfig.customTools]; if(!n[i])n[i]={}; n[i].url=e.target.value; setApiConfig({...apiConfig,customTools:n})}} />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex justify-between pt-4 border-t items-center">
                                     <div className="flex gap-2">
                                        <button onClick={()=>{
                                            const blob = new Blob([JSON.stringify({...apiConfig, apiKey: obfuscate(apiConfig.apiKey)}, null, 2)], {type:'application/json'});
                                            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'config.json'; a.click();
                                        }} className="text-xs text-blue-600 underline">å¯¼å‡ºé…ç½®</button>
                                        <input type="file" className="hidden" ref={configImportRef} onChange={e=>{
                                            const f=e.target.files[0]; if(f){const r=new FileReader(); r.onload=ev=>{try{const d=JSON.parse(ev.target.result); if(d.apiKey)d.apiKey=deobfuscate(d.apiKey); setApiConfig({...apiConfig,...d}); alert("å¯¼å…¥æˆåŠŸ")}catch(e){alert("æ ¼å¼é”™è¯¯")}}; r.readAsText(f);}
                                        }} />
                                        <button onClick={()=>configImportRef.current.click()} className="text-xs text-blue-600 underline">å¯¼å…¥é…ç½®</button>
                                    </div>
                                    <Button label="ä¿å­˜å¹¶ç”Ÿæ•ˆ" onClick={handleSaveSettings} className="w-24" />
                                </div>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>